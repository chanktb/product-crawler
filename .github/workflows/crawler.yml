name: KTB Product Crawl

on:
  schedule:
    # Ch·∫°y m·ªói 2 ph√∫t trong kho·∫£ng 0h-16h UTC (7h-23h gi·ªù VN)
    # G·ª£i √Ω: N·∫øu b·∫°n mu·ªën ch·∫°y m·ªói 2 ph√∫t, h√£y ƒë·ªïi th√†nh "*/2 0-16 * * *"
    - cron: "*/2 0-16 * * *"
  workflow_dispatch:

# Quy·ªÅn ƒë·ªÉ workflow c√≥ th·ªÉ commit v√† push code
permissions:
  contents: write

# Th√™m concurrency ƒë·ªÉ tr√°nh c√°c l·∫ßn ch·∫°y ch·ªìng ch√©o
# L·∫ßn ch·∫°y m·ªõi s·∫Ω b·ªã h·ªßy n·∫øu c√≥ m·ªôt l·∫ßn ch·∫°y c≈© ƒëang di·ªÖn ra
concurrency:
  group: ${{ github.workflow }}

jobs:
  crawl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests beautifulsoup4 pytz

      - name: Run crawler
        # Gi·∫£ s·ª≠ t√™n file python c·ªßa b·∫°n l√† crawler.py
        run: python crawler.py

      - name: Check for meaningful changes (new URLs > 0)
        id: check_meaningful_changes
        run: |
          echo "Checking content of last_file.txt for new URLs..."
          if grep -E -q '[1-9][0-9]* new URLs added' last_file.txt; then
            echo "Meaningful changes detected (new URLs found)."
            echo "has_new_urls=true" >> "$GITHUB_OUTPUT"
          else
            echo "No new URLs found. All are '0 new URLs added'."
            echo "has_new_urls=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check status and trigger image-crawler if idle
        if: steps.check_meaningful_changes.outputs.has_new_urls == 'true'
        id: trigger_dispatch
        env:
          GH_TOKEN: ${{ secrets.KTBIHOW_PAT }}
          TARGET_OWNER: 'ktbihow'
          TARGET_REPO: 'image-crawler'
          TARGET_WORKFLOW: 'crawler-image.yml'
        run: |
          echo "Triggering image-crawler..."
          in_progress_runs=$(gh run list --repo "${TARGET_OWNER}/${TARGET_REPO}" --workflow "${TARGET_WORKFLOW}" --status "in_progress" --status "queued" --limit 1 --json databaseId)
          if [[ "$in_progress_runs" != "[]" ]]; then
            echo "Target workflow is busy. Skipping trigger."
            echo "triggered=skipped" >> "$GITHUB_OUTPUT"
            echo "reason=Target workflow is busy" >> "$GITHUB_OUTPUT"
          else
            echo "Target workflow is idle. Triggering now..."
            gh api --method POST -H "Accept: application/vnd.github+json" "/repos/${TARGET_OWNER}/${TARGET_REPO}/dispatches" -f event_type='new_product_available'
            echo "Trigger dispatch sent successfully."
            echo "triggered=sent" >> "$GITHUB_OUTPUT"
            echo "reason=New URLs available" >> "$GITHUB_OUTPUT"
          fi

      - name: Send Log Content to Telegram
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          LOG_CONTENT=$(cat last_file.txt)
          TRUNCATED_LOG=$(echo "$LOG_CONTENT" | head -c 4000)
          # S·ª≠ d·ª•ng curl ƒë·ªÉ g·ª≠i, || echo ƒë·ªÉ kh√¥ng l√†m fail workflow n·∫øu c√≥ l·ªói
          curl -s -X POST https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage -d chat_id=$TELEGRAM_CHAT_ID -d text="$TRUNCATED_LOG" || echo "L·ªói khi g·ª≠i n·ªôi dung log!"

      - name: Send Success Message to Telegram
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚úÖ KTB Product Crawl - Done
            New URLs found: ${{ steps.check_meaningful_changes.outputs.has_new_urls }}
            Trigger status: ${{ steps.trigger_dispatch.outputs.triggered }} (${{ steps.trigger_dispatch.outputs.reason }})

      - name: Send Failure Message to Telegram
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: "‚ùå KTB Product Crawl - Fail."
      
      # B∆∞·ªõc commit ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ bao g·ªìm c·∫£ run_counter.json
      - name: Commit & push results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Th√™m t·∫•t c·∫£ c√°c file ƒë√£ thay ƒë·ªïi (bao g·ªìm *.txt v√† run_counter.json)
          git add .
          
          # Ch·ªâ commit n·∫øu c√≥ thay ƒë·ªïi, n·∫øu kh√¥ng th√¨ b·ªè qua ƒë·ªÉ tr√°nh l·ªói
          # `|| exit 0` s·∫Ω ngƒÉn workflow b√°o l·ªói n·∫øu kh√¥ng c√≥ g√¨ ƒë·ªÉ commit
          git commit -m "üìä Update crawl data and counter [skip ci]" || exit 0
          
          # ƒê·∫©y thay ƒë·ªïi l√™n repo
          git push
